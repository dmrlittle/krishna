{% extends 'mysite/base.html' %}
{% load static %}

{% block head %}
<!--<link rel="stylesheet" href="{% static 'chat/css/emojis.css' %}">-->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
<link href="{% static 'chat/lib/css/emoji.css' %}" rel="stylesheet">
<link rel="prefetch" href="{% static 'chat/emoji/full-emoji-list.json' %}">
<link rel="preload" href="{% static 'chat/emoji/full-emoji-list.json' %}">
<style>
.msg {
    background-color: #017bfd;
    padding: 8px;
    border-radius: 15px;
    margin-top: 10px;
    margin-right: 10px;
}
.msg1 {
    background-color: #f5f5f5;   
}
.no-border {
    border: 0;
    box-shadow: none; 
}

.overlay {
    position: relative;
    z-index:9;
    top:-100px;
}
</style>
{% endblock head %}

{% block content %}
<div class="d-flex align-items-center justify-content-center" style="height:90vh;">
    <div class="m-2" style="width:95vw;padding-top:40px;">
        <div class="row g-1">
            <div class="col-9">
               <div class="p-3 bg-dark text-white">Live Stream</div>
            </div>
            <div class="col-3">
                <div class="justify-content-between">
                    <div class="p-3 bg-dark text-white">Live Chat</div>
                    <div class="rounded-3 border border-dark border-1 mb-1 mt-1" style="height:75vh;overflow-y: auto;background-color: #fff;">
                        <div id="messages"></div>
                    </div>
                    <div class="input-group mb-3 rounded-3 border border-dark border-1" style="background-color: #fff;padding-left:5px">
                        <img id="emoji-ico" data-toggle="popover" src="{% static 'chat/svg/happy.svg' %}" style="margin:10px;" width="35px" height="35px" onclick='$("#emojs").show()'>
                        <input id="chat-message-input" type="text" data-emojiabl="true" class="form-control no-border" aria-label="Recipient's username" aria-describedby="button-addon2">
                        <button id="chat-message-submit" style="background-color:#017bfd;margin-left:-10px" type="submit" class="btn btn-lg"><img src="{% static 'chat/svg/send.svg' %}" width="30px" height="30px"></button>
                    </div>
                    <div id="emojis" class="chat-popup ovelay"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<div id="emojis" class="chat-popup" ></div>
{{ room_id|json_script:"room-id" }}
{{ username|json_script:"username" }}
<script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
<script src="{% static 'chat/js/DisMojiPicker.js' %}"></script>
<script>    
        const roomId = JSON.parse(document.getElementById('room-id').textContent);
        const username = JSON.parse(document.getElementById('username').textContent);
        
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomId
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            $("#messages").append(
            '<div class="d-flex align-items-center '+data.sender[0]+'">\
            <div class="text-left pr-1"> \
            <img src="https://img.icons8.com/color/40/000000/guest-female.png" width="40" class="img1" >\
            </div>\
            	<div><div class="d-flex align-items-center">\
                <div class="msg '+data.sender[1]+'"><span style="font-weight: 700;">'+data.username+'</span> <span style="font-size:11px;">'+data.dt+'</span>\
                    <div>'+data.message+'</div> \
                </div> \
    		</div>');
    		<!--<div class="text-mutesd" style="margin-left:10px;">'+data.time+'</div></div></div>');-->
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
</script>
<script src="https://cdn.jsdelivr.net/npm/emoji-button@0.6.0/dist/index.min.js"></script>
<script>
      window.addEventListener('DOMContentLoaded', () => {
  EmojiButton(document.querySelector('#emoji-ico'), function (emoji) {
    document.querySelector('#chat-message-input').value += emoji;
  });
});
</script>
{% endblock content %}