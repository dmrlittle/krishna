{% extends 'mysite/base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'chat/css/emojis.css' %}">
<style>
.msg {
    background-color: #f5f5f5;  
    padding: 8px;
    border-radius: 15px;
    margin-top: 10px;
    margin-right: 10px;
}
.no-border {
    border: 0;
    box-shadow: none; 
}
</style>
{% endblock head %}

{% block content %}
<div class="d-flex align-items-center justify-content-center" style="height:90vh;">
    <div style="height:600px;width:1000px;">
        <div class="row g-1">
            <div class="col-8">
               <div class="p-3 bg-dark text-white">Visual</div>
            </div>
            <div class="col-4">
                <div class="justify-content-between">
                    <div class="p-3 bg-dark text-white">Chat</div>
                    <div class="rounded-3 mb-2" style="height:500px;overflow-y: auto;background-color: #fff;">
                        <div id="messages"></div>
                    </div>
                    <div id="emojis" class="chat-popup" hidden></div>
                    <div class="input-group mb-3">
                        <input id="chat-message-input" type="text" class="form-control no-border" data-emojiable="true" aria-label="Recipient's username" aria-describedby="button-addon2">
                        <!--<img id="emoji-ico" data-toggle="popover" src="{% static 'chat/svg/smile.svg' %}" style="margin:5px;" width="30px" height="30px" onclick="emojipress()">-->
                        <button id="chat-message-submit" style="background-color: #fff;border-bottom-right-radius:5px;" type="submit" class="btn btn-lg"><img src="{% static 'chat/svg/send.svg' %}" width="30px" height="30px"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
{{ room_id|json_script:"room-id" }}
{{ username|json_script:"username" }}
<script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
<script src="{% static 'chat/js/DisMojiPicker.js' %}"></script>
<script>    
        const roomId = JSON.parse(document.getElementById('room-id').textContent);
        const username = JSON.parse(document.getElementById('username').textContent);
        
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomId
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            $("#messages").append(
            '<div class="d-flex align-items-center">\
            <div class="text-left pr-1"> \
            <img src="https://img.icons8.com/color/40/000000/guest-female.png" width="40" class="img1" >\
            </div>\
            	<div><div class="d-flex align-items-center">\
                <div class="msg"><span style="font-weight: 700">'+data.username+'</span> \
                    <div>'+data.message+'</div> \
                </div> \
    		</div>');
    		<!--<div class="text-mutesd" style="margin-left:10px;">'+data.time+'</div></div></div>');-->
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';
        };
</script>
<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover({ 
        html : true,
        sanitize: false,
        
        content: function() {
            return $('#emojis').html();
        },
        placement : 'top',
    });
});
</script>
<script>
    $("#emojis").disMojiPicker()
    $("#emojis").picker(emoji => console.log(emoji));
    twemoji.parse(document.body);
</script>
<script>
</script>
{% endblock content %}